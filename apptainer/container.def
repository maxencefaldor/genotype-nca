Bootstrap: docker
From: nvidia/cuda:11.6.2-cudnn8-devel-ubuntu20.04

%labels
    Author m.faldor22@imperial.ac.uk

%help
    Genotype Neural Cellular Automata

%environment
	# Activate virtual environment
	export VIRTUAL_ENV="/venv"
	export _OLD_VIRTUAL_PATH="$PATH"
	export PATH="$VIRTUAL_ENV/bin:$PATH"

	# System
	export TZ=Europe/London

%post
	export DEBIAN_FRONTEND=noninteractive

	# Update and install required libraries
	apt update
	apt install -y wget git software-properties-common

	# Install Python
	add-apt-repository ppa:deadsnakes/ppa
	apt install -y python3.11 python3.11-venv

	# Create a virtual environment
	python3.11 -m venv /venv
	. /venv/bin/activate
	python -m ensurepip
	pip install --upgrade pip

	# Install JAX
	pip install --upgrade jax==0.4.9 jaxlib==0.4.7+cuda11.cudnn82 -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

	# Clone repository to /project/
	git clone https://gitlab.doc.ic.ac.uk/AIRL/research_projects/maxence_faldor/v-qd.git /project/
	cd /project/
	git checkout $COMMIT
	git config --global --add safe.directory '*'

	# Install requirements
	pip install -r requirements.txt

%runscript
	# Run main
	python /project/main.py "$@"

